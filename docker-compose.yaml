version: '3.9'

services:
  # Banco de dados Oracle XE
  oracle-db:
    container_name: querybuilder-oracle-xe
    image: gvenzl/oracle-xe:21-slim
    ports:
      - "1522:1521"        # Porta do Oracle (1522 externa para evitar conflito)
      - "5501:5500"        # Porta do Enterprise Manager (opcional)
    environment:
      - ORACLE_PASSWORD=oracle
      - APP_USER=querybuilder
      - APP_USER_PASSWORD=querybuilder123
    volumes:
      - oracle-data:/opt/oracle/oradata   # PersistÃªncia dos dados
    healthcheck:
      test: ["CMD-SHELL", "echo 'SELECT 1 FROM dual;' | sqlplus -s system/oracle@//localhost:1521/XE || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - querybuilder-network

  # API QueryBuilder
  querybuilder-api:
    container_name: querybuilder-api
    build:
      context: .
      dockerfile: src/QueryBuilder.Api/Dockerfile
    ports:
      - "5249:8080"        # HTTP
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_URLS=http://+:8080
      - DatabaseSettings__ConnectionString=User Id=SYSTEM;Password=oracle;Data Source=oracle-db:1521/XE
      - DatabaseSettings__CommandTimeout=30
      - DatabaseSettings__EnableDetailedErrors=true
    depends_on:
      oracle-db:
        condition: service_healthy
    networks:
      - querybuilder-network
    restart: unless-stopped

volumes:
  oracle-data:
    driver: local

networks:
  querybuilder-network:
    driver: bridge
